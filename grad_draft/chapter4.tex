%%%%
\chapter{実験・評価}
\section{予備実験}
本実験に入る前に、予備実験を行った。
\subsection{予備実験(1)}
この実験はによる、上述のCassandraノードで発生する総通信量の推測が妥当であることを強調する。以下のTypeA,TypeBの2パターンで120台のCassandraノードを立ち上げて10分間計測を行い、推定される通信量が一致することを確認する。
\begin{itemize}
\item TypeA\\
一台あたりCassandraノード12個を立ち上げたマシン10台でクラスタを構成する。
\item typeB\\
一台あたりCassandraノード60個を立ち上げたマシン2台でクラスタを構成する。
\end{itemize}
図??が,TypeAの場合の取得した通信量の合計の時間変化、図？？がTypeBの場合である。\\
X軸は時間軸を示していて、Y軸は通信量(単位はM bit)を示している。
この値から総通信量を推定する。\\
Type A の場合は、時間tの時の通信量をA(t)とおくと、\\
$推定される通信量(t)  =  A(t) * 10 / 9$\\
Type Bの場合は、時間tの時の通信量をB(t)とおくと、\\
$推定される通信量(t)  =  B(t) * 2 / 1$\\
上の推定量をグラフに重ねて書いてみる。
先ほどと同様に、X軸は時間軸を示していて、Y軸は通信量(単位はM bit)である。
平均は、??でありほぞ一致することが確認できましたと。
\\
TypeA:120 cassandra nodes on 10 machines\\
TypeB:120 cassandra nodes on 2 machines\\
\subsection{予備実験(2)}
また、Cassandra特有のseedの数が変化されたときに、通信量がどのように変わるのかも調べた。
実験では、以下のように、seed数を1,2,4,10,60,120と変化させながら、２台のマシン上でcassandra120台を起動し通信量の変化を観察した

くらいか？グラフを一枚書いて終了！

\section{本実験}
%図??は、10 秒あたりのマシン間の総通 信量の変化をノード数別に表したグラフであ る。(ただし、1M =$10^6$,1K=$10^3$ とする。)ノードの台数によらず、100 秒以降は通信量 が安定していることがわかる。図？2 は、ノード数と通信量が安定して いる時の(ここでは、実験開始から 200-300 秒 後とした)1 秒あたりの通信量の平均をプロッ トしたものである。図中の曲線は、プロット した点から二次関数でフィッティングしたも のである。n をノードの台数として得られた関数は、	
 [通信量(bit)] = $224.6×n^2$ + 4314.8×n	
  である。
\section{評価}
\subsection{総通信量の見積もり}
通信量は O($n^2$)でスケール することがわかった。	この関数から、ノード台数をパラメータとし て Cassandra の Gossip  Protocol で発生しう る全体の通信量を推測することができる。例えば、n	
 = 1000のとき、[通信量]	= 229Mbps と なる。このように、この関数を使って総通信量 が見積もることができる。また、クラスタの設 計時にも活かすことができる。これは後述する。
\subsection{１ノードあたりの通信量}
また同様に、１ノードあたりの通信量を見積もることも可能である。総通信量をCassandra node
台数nで割った値が、１ノードあたりの通信量となる。つまり、\\
	$[１ノードあたりの通信量] =  (224.6×n^2	 + 4314.8×n) / n = 224.6×n	 + 4314.8$\\
とO(n)でスケールすることがわかる。グラフに示すと以下になる。
X軸がノード台数、Y軸が通信量である。また、この通信量はメンバーシップ管理で受信、送信する通信量のそれぞれの値である。
(グラフ)

\subsection{システム全体の限界とは？}
上より総通信量はある関数に沿って、スケールしていることがわかった。この結果は、クラスタ設計時 に活かすことができる。つまり、クラスタを構成するノード数に応じて、どの機器でどれくらいの通信量が発生するかを見積もることができる。一般的には議論するのは難しいので、クラスタの構成ごとに具体的なケースに商店を当てて見ていく。\\

\subsubsection{TYPEA:データセンター３つでクラスタを構成する場合}
\subsubsection{TYPE B:データセンター１つでクラスタを構成する場合}
\subsubsection{TYPE C:ネットワーク1000base-Tのような切り口}

\subsection{通信量がO($n^2$)でスケールしていく理由}
最後に、メンバーシップ管理の通信量がO($n^2$)でスケールしていく理由について考察する。Cassandraが採用するGossip Protocolに依存するところもあるため、まずCassandraのメンバーシップ管理の実装し、その後数式から考察していく。
\subsection{Cassandraのメンバーシップ管理の実装}
・gossip通信の定義
(往復何回あるかとかいう必要があるか？)
・毎秒どのようにどのノードとgossip通信を行うかのロジックについて。

\subsection{数式から説明}
ノード台数をnとして、安定時に発生する通信量がO($n^2$)であることをしめす。
\begin{itemize}
\item (ノード台数) = n
\item (総通信量/s) = (１台あたりの通信量/s) * (ノード台数)
\end{itemize}
さらに、(一台あたりの通信量/s)を分解すると、
\begin{itemize}
\item (１台あたりの通信量) = (１秒あたりのgossip通信する回数) * (一回あたりのgossip通信にかかる通信量)
\end{itemize}
ここで、Cassandraのメンバーシップ管理では、メンバー構成が安定時(TODO:どーやってもりこもうか。)には、
\begin{itemize}
\item (１秒あたりのgossip通信する回数) = 1,
\end{itemize}
一方、
\begin{itemize}
\item (一回あたりのgossip通信にかかる通信量) = Order(n)
\end{itemize}

よって、
\begin{itemize}
\item (１台あたりの通信量) = O(n)
\item (総通信量) = Order($n^2$)
\end{itemize}

となることが証明できた。また、安定時を考えると、１秒あたりのgossip通信する回数は、1回であるのでCassandra独自という意味合いはうすれ、より一般的なGossip Protocol baseのメンバーシップ管理アルゴリズムの結果といえる。(TODO:言い方うまく！)




% 図の例
\begin{figure}[tb]
 \begin{center}
  \includegraphics[width=10cm]{javassist.eps}
  \caption{Javassistの処理の流れ}
  \label{fig:javassist}
 \end{center}
\end{figure}

図~\ref{fig:javassist}は...

