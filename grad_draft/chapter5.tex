%%%%

\chapter{測定手法}
\section{実験シナリオ}
実験では、マスターとなるマシンを１台とワーカーとなるマシンを１０台を用意した。ワーカーマシンをlime11,lime12,...lime20と名付ける。マスターの役割は、通信量計測の開始・終了,Cassandraノードの起動,計測した記録の解析をワーカーに指示すること、最終的な通信量の推定を行うである。一方、ワーカーの役割は、通信量の計測、Cassandra ノー ドを起動すること、通信量の解析である。また、	1台あたり複数のCassandraノードを立ち上げる必要がある。Cassandraノードの立ち上げ方は、30 秒ごとに、1台あたり 10 ノードの Cassandra を一度に起 動し、これを目指す台数に達成するまで続ける。最初の Cassandra ノードを起動した瞬間から各マシンで10 分間の通信量を計測した。\\
計測後に各マシンで通信量を解析し、マスターとなるマシンに解析結果を送信する。マスターは、送られて通信量から合計値を出し、Cassandraで発生する通信量の推定を行う。\\
マスター、ワーカーで実行するプログラムは、シェルスクリプトでプログラムを書き、各ワーカーへの指示は、GXPを利用して制御した。また、パケット情報の解析には、java,R,シェルスクリプトを使った。\\
\subsection{実験環境}
以下に実験環境を示す。
\begin{itemize}
\item Cassandra 0.6.6	
\item OS Linux	 2.6.35.10 74.fc14.x86\_64
\item CPU: 2.40 GHz Xeon E5620 × 2
\item Java 仮想マシン: Java SE 6 Update 21
\item メモリー: 32GB RAM
\item ネットワーク: 1000BASE-T
\end{itemize}
\subsection{計測方法について}
計測にあたっていくつか工夫した点を紹介する。\\
\begin{itemize}
\item ユーザー,プロセスのシステムリソース制約を外す\\
通常のオペレーションでは、１ユーザに共有のシステムリソースを占有されないように管理されている。具体的には、１ユーザが同時に実行出来るプロセス数、ファイル・ディスクリプタの数や、ユーザーが実行するプロセスにおいて、仮想メモリーの使用領域、物理メモリーの使用領域などが制限される。
(img:左図がデフォルト,img右図設定ファイル変更後)

Cassandraノードの実行には、メモリー使用量域が大きく、使用するスレッド数が多い。特に上の環境では、スレッド数が130程度であった。(Cassandraの設定はデフォルト。)linuxのデフォルトの設定では、１ユーザが同時に実行出来るプロセス数は、1024であるので、(左図参照)Cassandraノードを７台までしか起動できなかった。

そこで、linuxのユーザーリソースを決める設定ファイルを編集し、１ユーザーのリソース制限、１プロセスのリソース制限を緩和した。(参照:右図)



\item IPエイリアシングを利用し、プライベートネットワークを構築\\
Cassandraのメンバー管理では、IPアドレスでメンバーを認識する。つまり、今回の実験ように１マシンあたり複数ノードのCassandraを立ち上げようとすると、不都合が生じる。\\
そこで、IPエイリアシングを使用して仮想アドレスを作成し、Cassandraノードごとに割り振ることにした。その結果、同じマシン上に立ち上がったCassandraマシン同士の差異が明らかになり、不整合が起きなくなった。\\
さらに、通信量の測定の際にはノイズを防がないといけない。ノイズとは、Cassandraノード以外から要求されるリクエストのことである。具体的には、ARPとか、PINGなどのリクエストである。これらのパケットを誤って計測してしまうことを避けるために、IPエイリアスリングを行うと同時に、プライベートネットワークを構築した。このネットワークに参加しているのは、Cassandraノードだけである。この作業で、プライベートネットワーク内で飛び交うパケットのみを取得すればよく、ノイズが減らすことができる。\\
具体的には、10.20.0.0/16のネットワークを構築した。さらにCassandraノードが物理的にどのマシン上で起動しているかを判別しているために、実マシン(lime11,lim12,...,lime20)上の番号nを使用し、lime[n]上で起動するマシンは、仮想的に10.20.n.0/24なるサブネットを設けた。例えば、n=19のとき、10.20.19.1 〜10.20.19.254までの仮想アドレスを作成しCassandraノードに割り当てた。以下がプライベートネットワークを構築後にifconfigコマンドを実行したときの実行結果と、このネットワーク内でCassandraクラスタが構成されている様子である。\\
% 図の例
\begin{wrapfigure}{center}{15cm}
  \includegraphics[width=15cm]{img/ipaliasing.eps}
  \caption{ifconfigの実行結果}
  \label{fig:javassist}
\end{wrapfigure}

\begin{wrapfigure}{center}{15cm}
  \includegraphics[width=15cm]{img/ring.eps}
  \caption{Cassandraクラスタを構成したときの様子}
  \label{fig:javassist}
\end{wrapfigure}

\item tcpdumpの使用\\
通信量の測定は、tcpdumpを使用した。上述したように、Cassandraノード同士のやりとりはプライベートネットワーク上で行われるので、このネットワークをまたぐすべてのTCPパケットのサイズを記録すればよい。具体的には、tcpdumpに以下のオプションをつけて実行した。取得するパケットは二つの条件でフィルターをかけた。
\begin{itemize}
\item src net 10.20.0.0/16\\
このフィルターにより、指定したデバイスを経由したパケットのうち、送信元が10.20.0.0/16のネットワークであるパケットのみが取得する。つまり、これで、このネットワーク以外のパケットを取得しないことになる。この条件で、余計なARPクエリなどを弾ける。
\item  dst net 10.20.(マシン番号).0/24\\
このフィルターにより、指定したデバイスを経由したパケットのうち、受信元が10.20.(マシン番号).0/16のネットワークであるパケットのみが取得できる。つまり、tcpdumpを実行するマシンで実行するCassandraノード宛のパケットを取得することになるのである。
\end{itemize}
この２つの条件により、他のマシンで起動しているCassandraノードからこのマシンで起動しているCassandraに送られてくるパケットだけを取得できるのである。以下、tcpdumpを実行したときの実行結果の例である。\\

% 図の例
\begin{figure}[tb]
 \begin{center}
  \includegraphics[width=15cm]{img/tcpdump.eps}
  \caption{tcpdumpの実行結果}
  \label{fig:javassist}
 \end{center}
\end{figure}



\item 同じマシン上で動作しているCassandraノード同士の通信は取得できない。\\
一方、tcpdumpで測定する方法では同じマシン上で動作しているCassandraノード同士の通信は取得できないことに留意したい。



\end{itemize}

\section{通信量の測定について}
tcpdumpを使用した上のような計測方法では、同じマシン上でのCassandraNode同士の通信を計測することはできない。そこで我々は仮定をもとに、計測した総通信量からCassandraノードで発生する総通信量を推測することにした。我々が立てた仮定である。(TODO:もっとうまい言い方で。)
\begin{itemize}
\item 任意のCassandra Node同士の通信量は平均すると同じである。
\end{itemize}
n台の各マシンでm台のcassandraノードを起動したとする。つまり、システム全体で合計 n × m台のCassandraノードが起動されている。各マシンでtcpdumpを使用して計測した得られたトラフィックの合計をTとし、Cassandraノードで発生する通信量TTとく。このとき、
\begin{equation}
T = ((n-1) * m台のcassandraノードで発生する通信量) 
\end{equation}

である。上の仮定を用いると、n * m台のcassandraノードで発生する通信量TTは、\\
\begin{equation}
TT = T * (n * m ) / ((n-1) * m ) = T * n / (n-1)
\end{equation}
とCassandraノードで発生する総通信量を推測することができた。

具体的に、n = 4台,m=2の時について、図を使いながら解説する。
(図)

\section{自動で通信量の測定を行い、その後解析を行うプログラムを作成した}
図のような自動で通信量の測定を行い、その後解析を行うプログラムを作成した。
% 図の例
\begin{figure}[tb]
 \begin{center}
  \includegraphics[width=15cm]{img/measureScript.eps}
  \caption{実行スクリプト}
  \label{fig:javassist}
 \end{center}
\end{figure}







